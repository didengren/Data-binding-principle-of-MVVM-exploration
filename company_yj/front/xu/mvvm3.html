<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>动态改变输入值</title>
</head>
<body>
<div id="app">
  <input type="text" v-model="text">
  {{text}}
</div>
<script>
/*
 * 订阅器/依赖
 */
function Dep(){
  this.subs = []
}
Dep.prototype = {
  addSub: function(sub){
    this.subs.push(sub)
    console.log(this.subs)
  },
  notify: function(){
    this.subs.forEach(function(sub){
      sub.update()
    })
  }
}

/*
 * 观察者 Observer
 * @param vm Vue实例
 * @param dataObj 数据池
 */
function Observer(dataObj, vm){
  Object.keys(dataObj).forEach(function(key){
    var dep = new Dep()
    Object.defineProperty(vm, key, {
      get: function(){
        if(Dep.__watcher__)
          dep.addSub(Dep.__watcher__)
        return dataObj[key]
      },
      set: function(newVal){
        if(newVal === dataObj[key]) return
        dataObj[key] = newVal
        dep.notify()
      }
    })
  })
}

/*
 * MVVM类 Vue
 * @param object{el//元素id, data//数据池 {text}, watch//事件监听处理对象}
 */
function Vue(options){
  this.data = options.data
  new Observer(this.data, this)
  this.watch = options.watch
  var parentNode = document.getElementById(options.el)
  this.nodeToFragment(parentNode)
}
Vue.prototype = {
  //加入碎片节点
  nodeToFragment: function(parentNode){
    var frag = document.createDocumentFragment()
    var childNode;
    while(childNode = parentNode.firstChild){
      this.compile(childNode)
      frag.appendChild(childNode)
    }
    parentNode.appendChild(frag)
  },
  //指令编译 调用观察者渲染模板
  compile: function(childNode){
    var _this = this
    var reg = /\{\{(.*)\}\}/
    if(childNode.nodeType === 1){
      var attrList = childNode.attributes
      for(var i=0; i<attrList.length; i++){
        if(attrList[i].nodeName=='v-model'){
          var vModelVal = attrList[i].nodeValue
          //初始化
          new Watcher(_this, vModelVal, childNode)
          //走观察者路线
          childNode.addEventListener('input', function(e){
            var newVal = e.target.value
            for(var item in _this.watch){
              _this.watch[item](newVal, _this)
            }
          })
          childNode.value = _this[vModelVal];
          childNode.removeAttribute('v-model')
        }
      }
    }
    if(childNode.nodeType === 3){
      if(reg.test(childNode.nodeValue)){
        var nvName = RegExp.$1.trim()
        //初始化
        new Watcher(_this, nvName, childNode)
      }
    }
  }
}

/*
 * 订阅者 Watcher
 * @param vm vue实例
 * @param nvName nodeValue占位符名
 * @param node childNode
 */
function Watcher(vm, nvName, node){
  Dep.__watcher__ = this
  this.vm = vm
  this.nvName = nvName
  this.node = node
  this.update()
  Dep.__watcher__ = null
}
Watcher.prototype = {
  update: function(){
    this.node.nodeValue = this.node.value = this.vm[this.nvName]
  }
}


// 实例化
new Vue({
  el: "app",
  data: {
    text: '请输入...'
  },
  watch: {
    kbInput: function(newVal, _this){
      _this.text = newVal
    }
  }
})
</script>
</body>
</html>